<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Visual Ruler</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; 
            margin: 0;
            padding: 1rem;
            box-sizing: border-box; 
        }
        .container {
            background-color: #ffffff; 
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            overflow: hidden; 
            max-width: 90%; 
            width: 100%;
            display: flex;
            flex-direction: column; 
            align-items: center; 
            padding: 1.5rem; 
        }
        .video-container {
            position: relative; 
            width: 100%;
            max-width: 640px; 
            aspect-ratio: 16 / 9; 
            background-color: #000; 
            border-radius: 0.75rem; 
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            transform: scaleX(-1); 
        }
        canvas {
            position: absolute; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto; 
            cursor: crosshair; 
        }
        .controls {
            display: flex;
            flex-wrap: wrap; 
            gap: 0.75rem;
            justify-content: center; 
            margin-bottom: 1.5rem;
        }
        .button {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600; 
            transition: all 0.2s ease-in-out; 
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
        }
        .button-primary {
            background-color: #3b82f6; 
            color: white;
        }
        .button-primary:hover {
            background-color: #2563eb; 
            transform: translateY(-1px);
        }
        .button-secondary {
            background-color: #e5e7eb; 
            color: #374151; 
        }
        .button-secondary:hover {
            background-color: #d1d5db; 
            transform: translateY(-1px);
        }
        .measurement-display {
            background-color: #f3f4f6; 
            padding: 1rem;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 640px; 
            text-align: center;
            font-size: 1.125rem;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }

        
        @media (min-width: 768px) {
            .container {
                flex-direction: row; 
                justify-content: space-between; 
                align-items: flex-start; 
                padding: 2rem;
                max-width: 1000px; 
            }
            .video-section {
                width: 60%;
                margin-right: 2rem;
                margin-bottom: 0;
            }
            .controls-panel {
                width: 40%;
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            .controls {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
                margin-bottom: 0;
            }
            .measurement-display {
                max-width: none;
                width: 100%;
                margin-top: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-section flex-grow">
            <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">AR Visual Ruler</h1>
            <div class="video-container">
                <video id="videoElement" autoplay playsinline></video>
                <canvas id="canvasElement"></canvas>
            </div>
            <div id="measurementDisplay" class="measurement-display">
                Click "Start Camera" to begin.
            </div>
        </div>

        <div class="controls-panel">
            <div class="controls">
                <button id="startCameraButton" class="button button-primary">Start Camera</button>
                <button id="clearPointsButton" class="button button-secondary">Clear Points</button>
            </div>
        </div>
    </div>

    <script>
        
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const ctx = canvas.getContext('2d');
        const startCameraButton = document.getElementById('startCameraButton');
        const clearPointsButton = document.getElementById('clearPointsButton');
        const measurementDisplay = document.getElementById('measurementDisplay');

        let points = [];

        function init() {
            startCameraButton.addEventListener('click', startCamera);
            clearPointsButton.addEventListener('click', clearPoints);
            canvas.addEventListener('click', handleCanvasClick);

            measurementDisplay.textContent = 'Click "Start Camera" to begin.';
            clearPointsButton.disabled = true;
        }

        async function startCamera() {
            try {
    
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                video.play();

            
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    drawLoop();
                    measurementDisplay.textContent = 'Camera started. Click on the video to place points.';
                    clearPointsButton.disabled = false;
                };

            } catch (err) {
                console.error('Error accessing camera:', err);
                measurementDisplay.textContent = 'Error: Could not access camera. Please ensure permissions are granted and no other application is using the camera.';
            }
        }

        function clearPoints() {
            points = [];
            measurementDisplay.textContent = 'Points cleared. Click on the video to place new points.';
            drawLoop(); 
        }

        function handleCanvasClick(event) {
            
            const rect = canvas.getBoundingClientRect();
            
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;

            if (points.length < 2) {
                points.push({ x, y });
            } else {
            
                points = [{ x, y }];
            }
            updateMeasurementDisplay(); 
            drawLoop(); 
        }

        function calculatePixelDistance(p1, p2) {
            if (!p1 || !p2) return 0;
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        
        function updateMeasurementDisplay() {
            if (points.length === 2) {
                const pixelDistance = calculatePixelDistance(points[0], points[1]);
                measurementDisplay.textContent = `Pixel Distance: ${pixelDistance.toFixed(2)} px`;
            } else if (points.length === 1) {
                measurementDisplay.textContent = 'First point placed. Click again for the second point.';
            } else {
                measurementDisplay.textContent = 'Click on the video to place points.';
            }
        }


        function drawLoop() {
        
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#FF0000';
            ctx.strokeStyle = '#FF0000';
            ctx.lineWidth = 3; 

            points.forEach((point, index) => {
                ctx.beginPath();
                ctx.arc(point.x, point.y, 8, 0, Math.PI * 2); 
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = '#FFFFFF'; 
                ctx.font = 'bold 14px Inter, sans-serif'; 
                ctx.fillText(`P${index + 1}`, point.x + 10, point.y - 10);
            });

            if (points.length === 2) {
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                ctx.lineTo(points[1].x, points[1].y);
                ctx.stroke();

                const midX = (points[0].x + points[1].x) / 2;
                const midY = (points[0].y + points[1].y) / 2;
                const pixelDistance = calculatePixelDistance(points[0], points[1]);

                let text = `${pixelDistance.toFixed(0)} px`;

                ctx.font = 'bold 14px Inter, sans-serif'; 
                const textMetrics = ctx.measureText(text);
                const textWidth = textMetrics.width;
                const textHeight = 18; 

                ctx.fillStyle = 'rgba(0, 0, 0, 0.6)'; 
                ctx.fillRect(midX - textWidth / 2 - 5, midY - textHeight / 2 - 5, textWidth + 10, textHeight + 10);

                ctx.fillStyle = '#FFFFFF'; 
                ctx.fillText(text, midX - textWidth / 2, midY + textHeight / 4 - 2); 
            }

            requestAnimationFrame(drawLoop);
        }

        window.onload = init;
    </script>
</body>
</html>
